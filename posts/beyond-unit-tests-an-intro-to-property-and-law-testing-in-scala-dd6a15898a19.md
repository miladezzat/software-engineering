---
card: "https://cdn-media-1.freecodecamp.org/images/1*QcyFEloaC2fG_naIOEYXbQ.jpeg"
tags: [Scala]
description: "I have been using ScalaCheck testing library for at least 2 y"
author: "Milad E. Fahmy"
title: "Beyond unit tests: an intro to property and law testing in Scala"
created: "2021-08-16T11:30:50+02:00"
modified: "2021-08-16T11:30:50+02:00"
---
<div class="site-wrapper">
<main id="site-main" class="site-main outer">
<div class="inner">
<article class="post-full post tag-scala tag-functional-programming tag-testing tag-technology tag-coding ">
<header class="post-full-header">
<h1 class="post-full-title">Beyond unit tests: an intro to property and law testing in Scala</h1>
</header>
<figure class="post-full-image">
<picture>
<source media="(max-width: 700px)" sizes="1px" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 1w">
<source media="(min-width: 701px)" sizes="(max-width: 800px) 400px,
(max-width: 1170px) 700px,
1400px" srcset="https://cdn-media-1.freecodecamp.org/images/1*QcyFEloaC2fG_naIOEYXbQ.jpeg 300w,
https://cdn-media-1.freecodecamp.org/images/1*QcyFEloaC2fG_naIOEYXbQ.jpeg 600w,
https://cdn-media-1.freecodecamp.org/images/1*QcyFEloaC2fG_naIOEYXbQ.jpeg 1000w,
https://cdn-media-1.freecodecamp.org/images/1*QcyFEloaC2fG_naIOEYXbQ.jpeg 2000w">
<img onerror="this.style.display='none'" src="https://cdn-media-1.freecodecamp.org/images/1*QcyFEloaC2fG_naIOEYXbQ.jpeg" alt="Beyond unit tests: an intro to property and law testing in Scala">
</picture>
</figure>
<section class="post-full-content">
<div class="post-content">
<h4 id="taking-your-unit-tests-to-the-next-level-">Taking your unit tests to the next level.</h4><p>I have been using ScalaCheck testing library for at least 2 years now. It allows you to take your unit tests to the next level.</p><ul><li><br>You can do <strong><strong>Property-based testing </strong></strong>by generating a lot of tests with random data and asserting properties on your functions. A simple code example is described below.</li><li>You can do <strong><strong>Law testing</strong></strong> that is even more powerful and allows you to check mathematical properties on your types.</li></ul><h1 id="property-based-testing">Property-based testing</h1><p>Here is our beloved <code>User</code> data type:</p><pre><code class="language-scala">case class User(name: String, age: Int)</code></pre><p>And a random <code>User</code> generator:</p><pre><code class="language-scala">import org.scalacheck.{ Gen, Arbitrary }
import Arbitrary.arbitrary
implicit val randomUser: Arbitrary[User] = Arbitrary(for {
randomName &lt;- Gen.alphaStr
randomAge  &lt;- Gen.choose(0,80)
} yield User(randomName, randomAge))</code></pre><p>We can now generate a <code>User</code> like this:</p><pre><code class="language-scala">scala&gt; randomUser.arbitrary.sample
res0: Option[User] = Some(User(OtwlaaxGbmdhuorlmgvXitbmGfbgetm,22))</code></pre><p>Let’s define some functions on the <code>User</code>:</p><pre><code class="language-scala">def isAdult: User =&gt; Boolean = _.age &gt;= 18
def isAllowedToDrink : User =&gt; Boolean = _.age &gt;= 21</code></pre><p>Let’s claim that:</p><p><strong><strong>All adults are allowed to drink.</strong></strong></p><p><strong><strong>Can we somehow prove this? Is this correct for all users?</strong></strong></p><p>This is where property testing comes to the rescue. It allows us not to write specific unit-tests. Here they would be:</p><ul><li>18-year-olds are not allowed to drink</li><li>19-year-olds are not allowed to drink</li><li>20-year-olds are not allowed to drink</li></ul><p>All of these statements can be replaced by a single property check:</p><pre><code class="language-scala">import org.scalacheck.Prop.forAll
val allAdultsCanDrink = forAll { u: User =&gt;
if(isAdult(u)) isAllowedToDrink(u) else true }</code></pre><p>Let’s run it:</p><pre><code class="language-scala">scala&gt; allAdultsCanDrink.check()
! Falsified after 0 passed tests.
&gt; ARG_0: User(,19)</code></pre><p>It fails as expected for a 19-year-old.</p><p>Property testing is awesome for a few reasons:</p><ul><li>Saves time by writing less specific tests</li><li>Finds new use cases generated by Scala check that you forgot to handle</li><li>Forces you think in a more general way</li><li>Gives you more confidence for refactoring than conventional unit tests</li></ul><h1 id="law-testing">Law testing</h1><p>It gets better: let’s take it to the next level and define an Ordering between Users:</p><pre><code class="language-scala">import scala.math.Orderingimplicit val userOrdering: Ordering[User] = Ordering.by(_.age)</code></pre><p>We want to make sure that we didn't<strong><strong> forget any edge cases </strong></strong>and that we defined our order properly. This property has a name, and it’s called a<strong><strong> total order.</strong></strong> It needs to holds for the following properties:</p><ul><li><strong><strong>Totality</strong></strong></li><li><strong><strong>Antisymmetry</strong></strong></li><li><strong><strong>Transitivity</strong></strong></li></ul><p><strong><strong>Can we somehow prove this? Is this correct for all users?</strong></strong></p><p>This is possible without writing a single test!</p><p>We use <code>cats-laws</code> library to define the laws we want to test on the ordering we defined:</p><pre><code class="language-scala">import cats.kernel.laws.discipline.OrderTests
import cats._
import org.scalatest.FunSuite
import org.typelevel.discipline.scalatest.Discipline
import org.scalacheck.ScalacheckShapeless._
class UserOrderSpec extends FunSuite with Discipline  {
//needed boilerplate to satisfy the dependencies of the framework
implicit def eqUser[A: Eq]: Eq[Option[User]] = Eq.fromUniversalEquals
//convert our standard ordering to a `cats` order
implicit val catsUserOrder: Order[User] = Order.fromOrdering(userOrdering)
//check all mathematical properties on our ordering
checkAll("User", OrderTests[User].order)
}</code></pre><p>Let’s run it:</p><pre><code class="language-scala">scala&gt; new UserOrderSpec().execute()
UserOrderSpec:
- User.order.antisymmetry *** FAILED ***
GeneratorDrivenPropertyCheckFailedException was thrown during property evaluation.
(Discipline.scala:14)
Falsified after 1 successful property evaluations.
Location: (Discipline.scala:14)
Occurred when passed generated values (
arg0 = User(h,17),
arg1 = User(edsb,17),
arg2 = org.scalacheck.GenArities$$Lambda$2739/1277317528@41d7b4cf
)
Label of failing property:
Expected: true
Received: false
- User.order.compare
- User.order.gt
- User.order.gteqv
- User.order.lt
- User.order.max
- User.order.min
- User.order.partialCompare
- User.order.pmax
- User.order.pmin
- User.order.reflexitivity
- User.order.reflexitivity gt
- User.order.reflexitivity lt
- User.order.symmetry
- User.order.totality
- User.order.transitivity</code></pre><p>Sure enough, it fails on the antisymmetry law! Same age and different names are not supposed to be equals. We forgot to use the name in our original <code>Ordering</code>, so let's fix it and rerun the laws:</p><pre><code class="language-scala">implicit val userOrdering: Ordering[User] = Ordering.by( u =&gt; (u.age, u.name))
scala&gt; new UserOrderSpec().execute()
UserOrderSpec:
- User.order.antisymmetry
- User.order.compare
- User.order.gt
- User.order.gteqv
- User.order.lt
- User.order.max
- User.order.min
- User.order.partialCompare
- User.order.pmax
- User.order.pmin
- User.order.reflexitivity
- User.order.reflexitivity gt
- User.order.reflexitivity lt
- User.order.symmetry
- User.order.totality
- User.order.transitivity</code></pre><p>And now it passes :)</p><p>If you are wondering what can you test besides <code>Order</code>s, go check out the docs here: <a href="https://typelevel.org/cats/typeclasses/lawtesting.html">https://typelevel.org/cats/typeclasses/lawtesting.html</a></p><h1 id="summary">Summary</h1><ul><li>Property tests are more powerful than unit tests. They allow us to define properties on functions and generate a large number of tests using random data generators.</li><li>Law testing takes it to the next level and uses the mathematical properties of structures like <code>Order</code> to generate the properties and the tests.</li><li>Next time you define an ordering and wonder if it’s well-defined, go ahead and run the laws on it!</li></ul>
</div>
<hr>
<hr>
</section>
</article>
</div>
</main>
</div>
<!-- Google Tag Manager (noscript) -->
<!-- End Google Tag Manager (noscript) -->
